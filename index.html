<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yuyu Ke — Login / Sign Up</title>

  <!-- Firebase SDKs -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, 
             createUserWithEmailAndPassword,
             signInWithEmailAndPassword,
             sendPasswordResetEmail,
             RecaptchaVerifier,
             signInWithPhoneNumber } 
             from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAi84zl0DN-gEdRmmeeVFEFP30ujkWOkQY",
      authDomain: "fire-22-a5355.firebaseapp.com",
      projectId: "fire-22-a5355",
      storageBucket: "fire-22-a5355.firebasestorage.app",
      messagingSenderId: "936330911897",
      appId: "1:936330911897:web:91ff4096a3abf975c3d808",
      measurementId: "G-SL5FMP1368"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.auth = auth; // make accessible globally
  </script>

  <!-- intl-tel-input CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #007BFF, #004E9F);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: #fff;
      color: #000;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      width: 350px;
      padding: 25px;
      text-align: center;
    }
    .hidden { display: none; }
    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background-color: #007BFF;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    .link {
      color: #007BFF;
      cursor: pointer;
      display: inline-block;
      margin-top: 10px;
    }
    .phone-row { display: flex; gap: 6px; align-items: center; }
    .iti { width: 100%; }
  </style>
</head>
<body>

  <div class="container">
    <h2 id="form-title">Login</h2>

    <!-- LOGIN FORM -->
    <div id="login-form">
      <input type="text" id="login-email" placeholder="Email (or leave empty if using phone)" />
      <div class="phone-row">
        <input type="tel" id="login-phone" placeholder="Phone number (optional)" />
      </div>
      <input type="password" id="login-password" placeholder="Password" />
      <a href="refferto.html"><button id="login-btn">Login  </button></a>
      <div id="recaptcha-container"></div>
      <p class="link" id="forgot-password">Forgot password?</p>
      <p class="link" id="show-signup">Don’t have an account? Sign up</p>
    </div>

    <!-- SIGNUP FORM -->
    <div id="signup-form" class="hidden">
      <input type="text" id="su-name" placeholder="Full name" required />
      <input type="text" id="su-username" placeholder="Preferred username (optional)" />
      <input type="email" id="su-email" placeholder="Email (or leave empty if using phone)" />
      <div class="phone-row">
        <input type="tel" id="su-phone" placeholder="Phone number (optional)" />
      </div>
      <input type="password" id="su-password" placeholder="Password" />
      <button id="signup-btn">Sign Up</button>
      <p class="link" id="show-login">Already have an account? Login</p>
    </div>

    <!-- OTP INPUT -->
    <div id="otp-popup" class="hidden">
      <h3>Enter OTP</h3>
      <input type="text" id="otp-input" maxlength="6" placeholder="6-digit code" />
      <button id="verify-otp">Verify OTP</button>
    </div>
  </div>

  <!-- intl-tel-input JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>

  <script type="module">
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, sendPasswordResetEmail,
             createUserWithEmailAndPassword, signInWithEmailAndPassword } 
             from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const auth = window.auth;

    // UI
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const otpPopup = document.getElementById('otp-popup');
    const showSignup = document.getElementById('show-signup');
    const showLogin = document.getElementById('show-login');
    const forgotPassword = document.getElementById('forgot-password');

    showSignup.onclick = () => { loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); };
    showLogin.onclick = () => { signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); };

    // intlTelInput setup
    const itiSignup = window.intlTelInput(document.getElementById('su-phone'), {
      separateDialCode: true, initialCountry: "auto",
      geoIpLookup: cb => fetch('https://ipapi.co/json').then(res=>res.json()).then(d=>cb(d.country_code)).catch(()=>cb('us'))
    });
    const itiLogin = window.intlTelInput(document.getElementById('login-phone'), {
      separateDialCode: true, initialCountry: "auto",
      geoIpLookup: cb => fetch('https://ipapi.co/json').then(res=>res.json()).then(d=>cb(d.country_code)).catch(()=>cb('us'))
    });

    // Recaptcha
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
      size: 'invisible'
    });

    // ===== SIGNUP =====
    document.getElementById('signup-btn').onclick = async () => {
      const email = document.getElementById('su-email').value.trim();
      const phone = itiSignup.getNumber();
      const password = document.getElementById('su-password').value;
      const username = document.getElementById('su-username').value.trim() || email;
      const name = document.getElementById('su-name').value.trim();

      try {
        if (email) {
          await createUserWithEmailAndPassword(auth, email, password);
          alert(`Signup successful for ${username}! OTP sent to email and phone.`);
        } else if (phone) {
          const appVerifier = window.recaptchaVerifier;
          const confirmationResult = await signInWithPhoneNumber(auth, phone, appVerifier);
          window.confirmationResult = confirmationResult;
          signupForm.classList.add('hidden');
          otpPopup.classList.remove('hidden');
        } else {
          alert('Enter either email or phone to sign up.');
        }
      } catch (error) {
        alert(error.message);
      }
    };

    // ===== LOGIN =====
    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('login-email').value.trim();
      const phone = itiLogin.getNumber();
      const password = document.getElementById('login-password').value;

      try {
        if (email) {
          await signInWithEmailAndPassword(auth, email, password);
          alert('Login successful!');
          // redirect to dashboard
        } else if (phone) {
          const appVerifier = window.recaptchaVerifier;
          const confirmationResult = await signInWithPhoneNumber(auth, phone, appVerifier);
          window.confirmationResult = confirmationResult;
          loginForm.classList.add('hidden');
          otpPopup.classList.remove('hidden');
        } else {
          alert('Enter email or phone to log in.');
        }
      } catch (error) {
        alert(error.message);
      }
    };

    // ===== OTP VERIFY =====
    document.getElementById('verify-otp').onclick = async () => {
      const code = document.getElementById('otp-input').value.trim();
      try {
        await window.confirmationResult.confirm(code);
        alert('OTP Verified. Logged in!');
      } catch (error) {
        alert('Invalid OTP. Try again.');
      }
    };

    // ===== PASSWORD RESET =====
    forgotPassword.onclick = async () => {
      const email = document.getElementById('login-email').value.trim();
      if (!email) return alert('Enter your email to reset password.');
      try {
        await sendPasswordResetEmail(auth, email);
        alert('Password reset link sent to your email.');
      } catch (err) {
        alert(err.message);
      }
    };
  </script>
</body>
</html>
